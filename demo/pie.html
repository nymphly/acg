<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Title</title>
  <style>
    html,
    body,
    #container {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }

    .palette-1 {
      fill: red
    }

    .palette-2 {
      fill: green
    }

    .palette-3 {
      fill: blue
    }

    .palette-4 {
      fill: magenta
    }

    .palette-5 {
      fill: yellow
    }

    .palette-6 {
      fill: cyan
    }

    .palette-7 {
      fill: pink
    }

    .selected {
      fill: navy;
    }
  </style>
  <script src='./../dist/bundle.js'>
  </script>
</head>

<body>
  <div id="container"></div>
</body>

<script>
  function getRandomData() {
    // return Array.from({ length: 7 }, () => Math.floor(Math.random() * 20));
    return Array.from({ length: 7 }, () => 1);
  }
</script>

<script>

  const container = document.querySelector('#container');

  const resizeObserver = new ResizeObserver(entries => {
    const container = entries[0];

    if (container) {
      if (container.contentBoxSize) {
        // Firefox implements `contentBoxSize` as a single content rect, rather than an array.
        const contentBoxSize = Array.isArray(container.contentBoxSize)
          ? container.contentBoxSize[0]
          : container.contentBoxSize;

        renderStage(contentBoxSize.inlineSize, contentBoxSize.blockSize);
      } else {
        renderStage(container.contentRect.width, container.contentRect.height);
      }
    }

    console.log('Bounds changed');
  });

  const data = getRandomData();
  const sum = data.reduce((acc, curr) => acc + curr, 0);
  const slicesData = data.map((value, index) => {
    return {
      value,
      index,
      weight: value / sum,
      name: `Data item #${index}`
    }
  });

  console.table(slicesData);

  const config = acg.templates.svg;
  const stage = acg.create(config);
  const rootLayer = stage.find('Root-Layer');
  const pather = acg.pather();

  const slicesFactory = rootLayer.factory('Slices-Factory', {
    tag: 'path',
    attrs: {
      stroke: 'white',
      fill: 'none',
      'data-acgPointType': 'slice'
    }
  });

  function renderStage(width, height) {
    slicesFactory.clear();
    const centerX = width / 2;
    const centerY = height / 2;
    const radius = 0.9 * Math.min(centerX, centerY);

    const START = -Math.PI / 2;
    let start = START;
    let weightCurrSum = 0;
    slicesData.forEach((d, index) => {
      pather.clear();

      const path = slicesFactory.add();
      path.attrs = {
        ...path.attrs,
        class: `palette-${index + 1}`
      }

      const destX = centerX + Math.cos(start) * radius;
      const destY = centerY + Math.sin(start) * radius;

      weightCurrSum += d.weight;
      start = START + 2 * Math.PI * weightCurrSum;

      pather
        .moveTo(centerX, centerY)
        .lineTo(destX, destY)
        .arcTo(radius, radius, 0, 0, 1, centerX + Math.cos(start) * radius, centerY + Math.sin(start) * radius)
        .close()
        .applyTo(path);
        
      
    });

    stage.render();
  }

  stage.container = container;
  resizeObserver.observe(container);

  container.addEventListener('click', e => {
    const { target } = e;
    if (target.dataset.acgPointType === 'slice') {
      const { classList } = target;
      if (classList.contains('selected')) {
        classList.remove('selected');
      } else {
        classList.add('selected');
      }
    }
  })
</script>

</html>